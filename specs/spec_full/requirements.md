# 需求文档

## 介绍
本需求旨在基于现有错题数据和通义千问大模型能力，提供“按错题聚类的原因分析”能力。教师可选取班级或学生的 Top N 错题，系统调用大模型输出共性原因、知识点建议以及后续提问提示，帮助教师快速理解学生失分原因并制定针对性复习策略。

## 需求

### 需求 1 - 错题集选择与校验

**用户故事：** 作为教师，我希望快速选择班级或个人的错题集合，系统能自动校验数量与数据完整性，确保后续分析输入可靠。

#### 验收标准

1. When 教师在分析对话入口选择班级与考试并填写 Top N 值时, the 错题分析服务 shall 校验该考试是否存在至少 N 道错题并给出剩余可选数量。
2. While 教师勾选具体学生或题目列表, when 选择的错题少于模型要求的最小数量时, the 错题分析服务 shall 阻止下一步并提示需要补充样本。
3. While 教师完成选择, when 点击“生成分析”时, the 错题分析服务 shall 生成标准化的错题输入包（题干、答案、学生答案、知识点标签、错题频次）并记录操作日志。

### 需求 2 - 大模型分析调用

**用户故事：** 作为教师，我希望系统能自动使用大模型对错题输入进行共性分析并输出结构化建议。

#### 验收标准

1. While 错题输入包有效, when 分析任务提交时, the 错题分析服务 shall 根据 `QWEN-VL-API-EXAMPLE.md` 定义的接口格式构造多轮对话消息并调用通义千问大模型。
2. When 模型返回成功响应时, the 错题分析服务 shall 将结果解析为统一结构（共性描述、易错知识点、错因剖析、教师可用追问），并写入 `ProcessingLog` 供追溯。
3. While 模型调用超时或失败, when 重试次数未超过阈值时, the 错题分析服务 shall 重试并在最终失败后返回带有错误码的提示信息。

### 需求 3 - 分析结果呈现

**用户故事：** 作为教师，我希望以直观的方式查看模型输出，并可复制或导出用于备课。

#### 验收标准

1. When 模型分析成功时, the 前端错题分析页面 shall 展示共性描述卡片、知识点建议列表、追问建议列表，并以时间戳标记最新分析。
2. When 教师点击“复制摘要”时, the 前端 shall 将结构化文本按照预设模板复制到剪贴板。
3. When 教师点击“导出为 Markdown”时, the 前端 shall 生成包含分析内容的 Markdown 文件并触发下载。

### 需求 4 - 追问提示与二次提问

**用户故事：** 作为教师，我希望可以基于模型给出的提示继续向模型提问，获得更深入的错因洞察。

#### 验收标准

1. While 第一次分析完成, when 教师在追问输入框中选择推荐问题或自定义问题并提交时, the 错题分析服务 shall 在已有对话上下文基础上追加消息并调用大模型。
2. When 追加提问成功时, the 前端 shall 将问答记录追加到对话历史并按照时间排序展示。
3. While 对话历史超过设定条数, when 教师继续追问时, the 错题分析服务 shall 自动裁剪上下文并保留最近 N 轮问答，确保调用符合模型输入限制。

### 需求 5 - 分析记录与复用

**用户故事：** 作为教师，我希望历史分析结果可以查阅，便于比较不同班级或时间的错因变化。

#### 验收标准

1. When 教师访问错题分析历史列表时, the 前端 shall 显示最近分析的班级、考试、Top N、创建时间以及发起人。
2. When 教师点击历史记录时, the 前端 shall 拉取对应的模型输出及对话日志，并以只读形式展示。
3. While 教师在历史记录页面点击“复用此分析”时, the 错题分析服务 shall 复制该记录的选题条件作为新的输入草稿并跳转到错题选择界面。
